% <*sty>
% <*@@=ctp>

\NeedsTeXFormat{LaTeX2e}

\ProvidesExplPackage {char2path} {2025-08-01} {v1.0.0}
  {A LaTeX package that converts characters into TikZ paths}

\tl_new:N \l_@@_tikz_data_merge_tl
\cs_new_protected_nopar:Npn \@@_load_font_data:n #1 
  {
    \clist_map_inline:nn {#1}
      {
        \file_get:nnNTF {ctp-##1.data.tex} {} \l_@@_tikz_data_single_tl
          {
            \tl_gput_right:NV \l_@@_tikz_data_merge_tl
              \l_@@_tikz_data_single_tl
          }
          {
            \msg_error:nnn { kernel } { file-not-found }
              {ctp-##1.data.tex}
          }
      }
    \exp_args:NNV \prop_const_from_keyval:Nn
      \c_@@_tikz_arabic_data_prop { \l_@@_tikz_data_merge_tl }
  }

% \cs_new_protected_nopar:Npn \@@_provide_data:n #1
%   {
%     \ProvidesExplFile{ctp-##1.data.tex}{\ctp@date}{\ctp@version}
%       {char2path ~ \text_titlecase:n {#1} ~ Data}
%   }

\keys_define:nn { char2path }
  {
    scale .tl_gset:N = \g_@@_scale_tl,
    scale .initial:n = { 10pt },
  }
\ProcessKeyOptions [ char2path ]

% env setup

\RequirePackage{tikz, etoolbox}
\usetikzlibrary{patterns, fadings}

\patchcmd{\pgfutil@InputIfFileExists}
  { \input #1 }
  {
    \@pushfilename
    \xdef\@currname{#1}
    \input #1
    \@popfilename
  }{}{}

\tl_const:Nn \c_@@_tikz_folder_tl { lmm_nums_tikz }

\prop_const_from_keyval:Nn \c_@@_scale_prop
  {
    10pt = 0.820, % basic scale factor
    11pt = 0.902,
    12pt = 0.984,
    13pt = 1.066,
    14pt = 1.148,
    15pt = 1.230,
    16pt = 1.311,
  }

% path data (0, 1, 2, 3, ..., 9)

\@@_load_font_data:n { llm-arabic, llm-alpha-small, llm-alpha-caps }

% user interface (basic)

\NewDocumentCommand \chartopath
  { O { draw = black, line~width = .01cm } m }
  { \tl_map_inline:nn {#2} { \@@_draw:ee {#1} { \@@_data:e {##1} } } }
\fp_const:Nn \c_@@_global_scale_fp { .0135 }
\clist_const:Nn \c_@@_baseline_anchor_above { ', ^, `, }
\clist_const:Nn \c_@@_baseline_anchor_below { Q, g, j, p, q, y, _, }
\cs_new_protected:Npn \@@_draw:nn #1#2
  {
    \tikz \node
      [ inner~sep = .054pt * \f@size ]%minimum~width = .7*\f@size (or 1ex?),
      { \tikz [ scale = \prop_item:Ne \c_@@_scale_prop { \g_@@_scale_tl } *
                        \fp_eval:n { \f@size/8.4 * \c_@@_global_scale_fp }
              ] \path [#1] #2;};
  }
\cs_generate_variant:Nn \@@_draw:nn { ne, ee }

\cs_new:Npn \@@_data:n #1
  {
    \prop_if_in:NnTF \c_@@_tikz_arabic_data_prop { #1 }
      { \prop_item:Nn \c_@@_tikz_arabic_data_prop { #1 } }
      { node [ draw, rounded~corners = .5pt, inner~xsep = -.06pt ] {?} }
    % \file_if_exist_input:n
    %   { \c_@@_tikz_folder_tl/lmm_#2.tikz }
  }
\cs_generate_variant:Nn \@@_data:n { e }

% user interface (fading)

\keys_define:nn { char2path / charfading }
  {
    colorset    .clist_set:N  = \l_@@_color_clist,
      colorset  .initial:n    = {black, white},
    direction   .tl_set:N     = \l_@@_direction_tl,
      direction .initial:n    = east,
  }
\tl_set:Nn \l_@@_direction_north_tl { north }
\tl_set:Nn \l_@@_direction_south_tl { south }

\clist_new:N \l_@@_continous_color_left_clist
\clist_new:N \l_@@_continous_color_right_clist
\seq_new:N \l_@@_tmp_seq

\NewDocumentCommand \charfading { O{} m }
  {
    \group_begin:
    \keys_set:nn { char2path / charfading } {#1}
    \@@_continous_colorset_aux:NNN \l_@@_color_clist
      \l_@@_color_i_tl \l_@@_color_ii_tl
    \@@_continous_color_aux:nNN {#2}
      \l_@@_continous_color_left_clist
      \l_@@_continous_color_right_clist
    \seq_set_split:Nnn \l_@@_tmp_seq {} {#2}
    \int_step_inline:nn { \tl_count:n {#2} }
      {
        \tl_set:Nn \l_@@_continous_color_tmpa_tl
          { \clist_item:Nn \l_@@_continous_color_left_clist {##1} }
        \tl_set:Nn \l_@@_continous_color_tmpb_tl
          { \clist_item:Nn \l_@@_continous_color_right_clist {##1} }
        \tl_set:Nn \l_@@_continous_color_tmpc_tl
          { \seq_item:Nn \l_@@_tmp_seq {##1} }
        \str_case_e:nnT { \l_@@_direction_tl }
          { { north } {} { south } {} }
          {
            \chartopath
              [
                fill = \l_@@_color_tl,
                path ~ fading = \l_@@_direction_tl
              ] { \l_@@_continous_color_tmpc_tl }
          }
        \str_if_eq:eeT { \l_@@_direction_tl } { horizontal }
          {
            \chartopath
              [
                left  ~ color =
                  \fp_compare:nNnTF
                    { \fp_eval:n { 100 - \l_@@_continous_color_tmpa_tl } } <
                    { \l_@@_continous_color_tmpa_tl }
                    {
                      \l_@@_color_ii_tl!
                      \fp_eval:n { 100 - \l_@@_continous_color_tmpa_tl }!
                      \l_@@_color_i_tl!\l_@@_continous_color_tmpa_tl,
                    }
                    {
                      \l_@@_color_i_tl!\l_@@_continous_color_tmpa_tl!
                      \l_@@_color_ii_tl!
                      \fp_eval:n { 100 - \l_@@_continous_color_tmpa_tl },
                    }
                ,
                right ~ color =
                  \fp_compare:nNnTF
                    { \fp_eval:n { 100 - \l_@@_continous_color_tmpb_tl } } <
                    { \l_@@_continous_color_tmpb_tl }
                    {
                      \l_@@_color_ii_tl!
                      \fp_eval:n { 100 - \l_@@_continous_color_tmpb_tl }!
                      \l_@@_color_i_tl!
                      \l_@@_continous_color_tmpb_tl
                    }
                    {
                      \l_@@_color_i_tl!
                      \l_@@_continous_color_tmpb_tl!
                      \l_@@_color_ii_tl!
                      \fp_eval:n { 100 - \l_@@_continous_color_tmpb_tl }
                    }
              ] { \l_@@_continous_color_tmpc_tl }
          }
      }
    \group_end:
  }

\cs_new_protected:Npn \@@_continous_colorset_aux:NNN #1#2#3
  {
    \group_begin: \exp_args:NNNe \group_end:
    \tl_set:Nn #2 { \clist_item:Nn #1 { 1 } }
    \group_begin: \exp_args:NNNe \group_end:
    \tl_set:Nn #3 { \clist_item:Nn #1 { 2 } }
  }

\cs_new_protected:Npn \@@_continous_color_aux:nNN #1#2#3
  {
    \int_step_inline:nn { \tl_count:n {#1} }
      {
        \clist_put_right:Ne #2
          { \fp_eval:n { 100 - (##1 - 1) * 100 / \tl_count:n {#1} } }
        \clist_put_right:Ne #3
          { \fp_eval:n { 100 - ##1 * 100 / \tl_count:n {#1} } }
      }
  }

\file_input_stop:
